<Project>

  <PropertyGroup>
    <GetTargetPathDependsOn>$(GetTargetPathDependsOn);AddGenerationTimeReferences</GetTargetPathDependsOn>
  </PropertyGroup>

  <!-- 
    https://github.com/dotnet/roslyn/issues/52017#issuecomment-1046216200
    This automatically adds explicit and transient dependencies so that they are available at the time the generator is executed. 
    Splitting to .netstandard 2.0 only is needed because of this issue: https://github.com/dotnet/roslyn/issues/60004
  -->
  <Target Name="AddGenerationTimeReferences" AfterTargets="ResolvePackageDependenciesForBuild">
    <ItemGroup>
      <_SystemLibs Include="Microsoft.Bcl.AsyncInterfaces" />
      <_SystemLibs Include="Microsoft.CodeAnalysis" />
      <_SystemLibs Include="Microsoft.CodeAnalysis.CSharp" />
      <_SystemLibs Include="Microsoft.CodeAnalysis.CSharp.Workspaces" />
      <_SystemLibs Include="Microsoft.CodeAnalysis.Workspaces" />
      <_SystemLibs Include="System.Buffers" />
      <_SystemLibs Include="System.Collections.Immutable" />
      <_SystemLibs Include="System.Composition.AttributedModel" />
      <_SystemLibs Include="System.Composition.Convention" />
      <_SystemLibs Include="System.Composition.Hosting" />
      <_SystemLibs Include="System.Composition.Runtime" />
      <_SystemLibs Include="System.Composition.TypedParts" />
      <_SystemLibs Include="System.IO.Pipelines" />
      <_SystemLibs Include="System.Memory" />
      <_SystemLibs Include="System.Numerics.Vectors" />
      <_SystemLibs Include="System.Reflection.Metadata" />
      <_SystemLibs Include="System.Runtime.CompilerServices.Unsafe" />
      <_SystemLibs Include="System.Text.Encoding.CodePages" />
      <_SystemLibs Include="System.Threading.Tasks.Extensions" />
    </ItemGroup>

    <PropertyGroup>
      <_SystemLibsProperty>@(_SystemLibs)</_SystemLibsProperty>
    </PropertyGroup>

    <ItemGroup>
      <ResolvedCompileFileDefinitionsWithoutSystem Include="%(ResolvedCompileFileDefinitions.Identity)" Condition="!$(_SystemLibsProperty.Contains(%(ResolvedCompileFileDefinitions.Filename)))" />
    </ItemGroup>

    <PropertyGroup>
      <_ResolvedCompileFileDefinitions>@(ResolvedCompileFileDefinitions)</_ResolvedCompileFileDefinitions>
      <NetStandard20Only>!$(_ResolvedCompileFileDefinitions.Contains('netstandard1.'))</NetStandard20Only>
    </PropertyGroup>

    <ItemGroup Condition="$(NetStandard20Only)">
      <None Include="@(ResolvedCompileFileDefinitionsWithoutSystem)" Pack="true" PackagePath="analyzers/dotnet/cs" />
      <TargetPathWithTargetPlatformMoniker Include="@(ResolvedCompileFileDefinitionsWithoutSystem)" IncludeRuntimeDependency="false" />
    </ItemGroup>

    <ItemGroup Condition="!$(NetStandard20Only)">
      <None Include="@(ResolvedCompileFileDefinitions)" Pack="true" PackagePath="analyzers/dotnet/cs" />
      <!-- No need to include base dependencies here -->
      <TargetPathWithTargetPlatformMoniker Include="@(ResolvedCompileFileDefinitionsWithoutSystem)" IncludeRuntimeDependency="false" />
    </ItemGroup>

    <Message Text="Added generation time reference: %(ResolvedCompileFileDefinitionsWithoutSystem.Identity)" Importance="high" Condition="$(NetStandard20Only) AND $(_ResolvedCompileFileDefinitions) != ''"/>
    <Message Text="Recognized dependencies that do not use netstandard2.0. All dependencies will be added including System and Microsoft" Importance="high" Condition="!$(NetStandard20Only) AND $(_ResolvedCompileFileDefinitions) != ''"/>
    <Message Text="Added generation time reference: %(ResolvedCompileFileDefinitions.Identity)" Importance="high" Condition="!$(NetStandard20Only) AND $(_ResolvedCompileFileDefinitions) != ''"/>
  </Target>

</Project>